<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>變更偵測大觀 – 運算 › 翻譯蒟蒻</title>
  <meta name="author" content="Brian">
  
  <meta name="description" content="原文：https://angular.love/change-detection-big-picture-operations
Change Detection 大觀 - 運算運算當 Angular 為特定的 component（視圖）執行 change detection 時，它會執行一些運算。這些運算有時被稱為副作用，如同計算邏輯的副作用：

在電腦科學中，如果一個運算、函式或表達式修改了其局部環境之外的某些狀態變數值，則稱其具有副作用，也就是說，如果它除了將值返回給運算的調用者之外，還有任何可觀察到的影響。

在 Angular 中，change detection 的主要副作用是將應用程式狀態渲染到目標平台上。大多數情況下，目標平台是瀏覽器，應用程式狀態的形式是 component 屬性，而渲染涉及更新 DOM。
在檢查 component 時，Angular 會執行其他一些運算。我們可以透過探索 refreshView 函式來識別它們。經過簡化的函式主體，以及我的解釋性註解如下：">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="變更偵測大觀 – 運算"/>
  <meta property="og:site_name" content="翻譯蒟蒻"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/TranslationKonjac/favicon.png" rel="icon">
  <link rel="alternate" href="/TranslationKonjac/atom.xml" title="翻譯蒟蒻" type="application/atom+xml">
  <link rel="stylesheet" href="/TranslationKonjac/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/TranslationKonjac/">翻譯蒟蒻</a></h1>
  <h2><a href="/TranslationKonjac/"></a></h2>
  <nav id="main-nav">
    <ul>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title">變更偵測大觀 – 運算</h1>
  

      
        <time datetime="2025-01-04T13:20:43.000Z">2025-01-04</time>
      
    </header>
    <div class="entry">
      
        <p>原文：<a target="_blank" rel="noopener" href="https://angular.love/change-detection-big-picture-operations">https://angular.love/change-detection-big-picture-operations</a></p>
<h1 id="Change-Detection-大觀-運算"><a href="#Change-Detection-大觀-運算" class="headerlink" title="Change Detection 大觀 - 運算"></a>Change Detection 大觀 - 運算</h1><h2 id="運算"><a href="#運算" class="headerlink" title="運算"></a>運算</h2><p>當 Angular 為特定的 component（視圖）執行 change detection 時，它會執行一些運算。<br>這些運算有時被稱為副作用，如同計算邏輯的副作用：</p>
<blockquote>
<p>在電腦科學中，如果一個運算、函式或表達式修改了其局部環境之外的某些狀態變數值，則稱其具有副作用，也就是說，如果它除了將值返回給運算的調用者之外，還有任何可觀察到的影響。</p>
</blockquote>
<p>在 Angular 中，change detection 的主要副作用是將應用程式狀態渲染到目標平台上。<br>大多數情況下，目標平台是瀏覽器，應用程式狀態的形式是 component 屬性，而渲染涉及更新 DOM。</p>
<p>在檢查 component 時，Angular 會執行其他一些運算。<br>我們可以透過探索 <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/02f3d12a0dc2c1b6f5ae06fff019058036fa5edc/packages/core/src/render3/instructions/shared.ts#L357"><code>refreshView</code></a> 函式來識別它們。<br>經過簡化的函式主體，以及我的解釋性註解如下：</p>
<span id="more"></span>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">refreshView</span>(<span class="params">tView, lView, templateFn, context</span>) &#123;</span><br><span class="line">  <span class="title function_">enterView</span>(lView);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (templateFn !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 更新子 component 的 input bindings</span></span><br><span class="line">      <span class="comment">// 執行 ngOnInit、ngOnChanges 和 ngDoCheck hooks</span></span><br><span class="line">      <span class="comment">// 更新當前 component 的 DOM</span></span><br><span class="line">      <span class="title function_">executeTemplate</span>(tView, lView, templateFn, <span class="title class_">RenderFlags</span>.<span class="property">Update</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 執行 ngOnInit、ngOnChanges 和 ngDoCheck hooks</span></span><br><span class="line">    <span class="comment">// 如果它們沒有從 template 函式中執行</span></span><br><span class="line">    <span class="keyword">const</span> preOrderCheckHooks = tView.<span class="property">preOrderCheckHooks</span>;</span><br><span class="line">    <span class="keyword">if</span> (preOrderCheckHooks !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">executeCheckHooks</span>(lView, preOrderCheckHooks, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首先，將在此 lView 中宣告的 transplanted views 標記為在其插入點需要刷新。</span></span><br><span class="line">    <span class="comment">// 這是為了避免在 `LView` 中定義 template，但其宣告出現在插入 component 之後的情況。</span></span><br><span class="line">    <span class="title function_">markTransplantedViewsForRefresh</span>(lView);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 刷新透過 ViewContainerRef.createEmbeddedView() 加入的視圖</span></span><br><span class="line">    <span class="title function_">refreshEmbeddedViews</span>(lView);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Content query 結果必須在呼叫 content hooks 之前刷新。</span></span><br><span class="line">    <span class="keyword">if</span> (tView.<span class="property">contentQueries</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">refreshContentQueries</span>(tView, lView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 執行 content hooks (AfterContentInit, AfterContentChecked)</span></span><br><span class="line">    <span class="keyword">const</span> contentCheckHooks = tView.<span class="property">contentCheckHooks</span>;</span><br><span class="line">    <span class="keyword">if</span> (contentCheckHooks !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">executeCheckHooks</span>(lView, contentCheckHooks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 執行透過 @HostBinding() 加入的邏輯</span></span><br><span class="line">    <span class="title function_">processHostBindingOpCodes</span>(tView, lView);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 刷新子 component 視圖。</span></span><br><span class="line">    <span class="keyword">const</span> components = tView.<span class="property">components</span>;</span><br><span class="line">    <span class="keyword">if</span> (components !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">refreshChildComponents</span>(lView, components);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// View query 必須在刷新子 component 之後執行，因為此視圖中的 template 可以插入到子 component 中。</span></span><br><span class="line">    <span class="comment">// 如果 view query 在子 component 刷新之前執行，則 template 可能尚未插入。</span></span><br><span class="line">    <span class="keyword">const</span> viewQuery = tView.<span class="property">viewQuery</span>;</span><br><span class="line">    <span class="keyword">if</span> (viewQuery !== <span class="literal">null</span>) &#123;</span><br><span class="line">      executeViewQueryFn&lt;T&gt;(<span class="title class_">RenderFlags</span>.<span class="property">Update</span>, viewQuery, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 執行 view hooks (AfterViewInit, AfterViewChecked)</span></span><br><span class="line">    <span class="keyword">const</span> viewCheckHooks = tView.<span class="property">viewCheckHooks</span>;</span><br><span class="line">    <span class="keyword">if</span> (viewCheckHooks !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">executeCheckHooks</span>(lView, viewCheckHooks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在檢查 component 後重置 dirty 狀態</span></span><br><span class="line">    <span class="keyword">if</span> (!isInCheckNoChangesPass) &#123;</span><br><span class="line">      lView[<span class="variable constant_">FLAGS</span>] &amp;= ~(<span class="title class_">LViewFlags</span>.<span class="property">Dirty</span> | <span class="title class_">LViewFlags</span>.<span class="property">FirstLViewPass</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 這一個很棘手 :) 需要自己的章節，我們稍後會探討它</span></span><br><span class="line">    <span class="keyword">if</span> (lView[<span class="variable constant_">FLAGS</span>] &amp; <span class="title class_">LViewFlags</span>.<span class="property">RefreshTransplantedView</span>) &#123;</span><br><span class="line">      lView[<span class="variable constant_">FLAGS</span>] &amp;= ~<span class="title class_">LViewFlags</span>.<span class="property">RefreshTransplantedView</span>;</span><br><span class="line">      <span class="title function_">updateTransplantedViewCount</span>(lView[<span class="variable constant_">PARENT</span>] <span class="keyword">as</span> <span class="title class_">LContainer</span>, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="title function_">leaveView</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們將在「渲染引擎內部」章節中詳細介紹所有這些運算。</p>
<p>現在，讓我們回顧一下從我上面展示的函式中推斷出的<strong>change detection 期間執行的核心運算</strong>。<br>以下是按指定順序排列的此類運算列表：</p>
<ol>
<li>在當前視圖的更新模式中執行 template 函式<ol>
<li>檢查並<a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/provider.ts#L154">更新</a> 子 component&#x2F;directive 實例上的 input 屬性</li>
<li>如果 bindings 發生變化，則在子 <a target="_blank" rel="noopener" href="https://angular.love/component-initialization-without-ngoninit-with-async-pipes-for-observables-and-ngonchanges">component</a> 上執行 <code>ngOnInit</code>、<code>ngDoCheck</code> 和 <code>ngOnChanges</code> hooks</li>
<li>如果目前視圖 component 實例上的屬性發生變化，則<a target="_blank" rel="noopener" href="https://hackernoon.com/the-mechanics-of-dom-updates-in-angular-3b2970d5c03d">更新</a>目前視圖的 DOM 插值</li>
</ol>
</li>
<li>如果沒有在上一步中運行，則執行 executeCheckHooks<ol>
<li>如果 bindings 發生變化，則在子 component 上 <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/provider.ts#L202">呼叫</a> <code>OnChanges</code> 生命週期 hook</li>
<li>在子 component 上 <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/provider.ts#L202">呼叫</a> <a target="_blank" rel="noopener" href="https://angular.love/if-you-think-ngdocheck-means-your-component-is-being-checked-read-this-article/"><code>ngDoCheck</code></a> （OnInit 僅在第一次檢查期間呼叫）</li>
</ol>
</li>
<li>markTransplantedViewsForRefresh<ol>
<li>尋找需要向下刷新 LView 鏈的 transplanted views，並將其標記為 dirty</li>
</ol>
</li>
<li>refreshEmbeddedViews<ol>
<li>為透過 <code>ViewContainerRef</code> APIs 建立的視圖<a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/view.ts#L327">運行 change detection</a> （主要重複此列表中的步驟）</li>
</ol>
</li>
<li>refreshContentQueries<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/query.ts#L91">更新</a> 子視圖 component 實例上的 <code>ContentChildren</code> query 列表</li>
</ol>
</li>
<li>執行 Content CheckHooks (<code>AfterContentInit</code>、<code>AfterContentChecked</code>)<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/provider.ts#L503">呼叫</a> 子 component 實例上的 <code>AfterContentChecked</code> 生命周期 hooks（<code>AfterContentInit</code> 僅在第一次檢查期間呼叫）</li>
</ol>
</li>
<li>processHostBindingOpCodes<ol>
<li>檢查並更新透過 component 類別內部的 <code>@HostBinding()</code> 語法新增的 host DOM 元素上的 DOM 屬性</li>
</ol>
</li>
<li>refreshChildComponents<ol>
<li>為當前 component 的 template 中引用的子 component <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/view.ts#L327">運行 change detection</a>。如果 <code>OnPush</code> component 不 dirty，則會跳過它們</li>
</ol>
</li>
<li>executeViewQueryFn<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/query.ts#L91">更新</a> 當前視圖 component 實例上的 <code>ViewChildren</code> query 列表</li>
</ol>
</li>
<li>執行 View CheckHooks (<code>AfterViewInit</code>、<code>AfterViewChecked</code>)<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/6b79ab5abec8b5a4b43d563ce65f032990b3e3bc/packages/core/src/view/provider.ts#L503">呼叫</a> 子 component 實例上的 <code>AfterViewChecked</code> 生命周期 hooks（<code>AfterViewInit</code> 僅在第一次檢查期間呼叫）</li>
</ol>
</li>
</ol>
<p>這是說明上述運算的圖表：</p>
<p><img src="https://wp.angular.love/wp-content/uploads/2024/08/2-6.png" alt="Image 13: Image alt"></p>
<h2 id="觀察"><a href="#觀察" class="headerlink" title="觀察"></a>觀察</h2><p>根據上面列出的運算，有幾件事需要強調。第一個也是最有趣的是，<strong>當前視圖的 change detection 負責啟動子視圖的 change detection。</strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://angular.love/ngtemplateoutlet-the-secret-to-customisation/">檢查什麼是 ngTemplateOutlet</a>！</strong></p>
<p>這遵循 <code>refreshChildComponents</code> 運算（上面列表中的 #8）。<br>對於每個子 component，Angular 執行<br><a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/02f3d12a0dc2c1b6f5ae06fff019058036fa5edc/packages/core/src/render3/instructions/shared.ts#L1687"><code>refreshComponent</code></a> 函式：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">refreshComponent</span>(<span class="params">hostLView, componentHostIdx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> componentView = <span class="title function_">getComponentLViewByIndex</span>(componentHostIdx, hostLView);</span><br><span class="line">  <span class="comment">// 只有已附加且為 CheckAlways 或 OnPush 且為 dirty 的 component 才應刷新</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">viewAttachedToChangeDetector</span>(componentView)) &#123;</span><br><span class="line">    <span class="keyword">const</span> tView = componentView[<span class="variable constant_">TVIEW</span>];</span><br><span class="line">    <span class="keyword">if</span> (componentView[<span class="variable constant_">FLAGS</span>] &amp; (<span class="title class_">LViewFlags</span>.<span class="property">CheckAlways</span> | <span class="title class_">LViewFlags</span>.<span class="property">Dirty</span>)) &#123;</span><br><span class="line">      <span class="title function_">refreshView</span>(tView, componentView, tView.<span class="property">template</span>, componentView[<span class="variable constant_">CONTEXT</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (componentView[<span class="variable constant_">TRANSPLANTED_VIEWS_TO_REFRESH</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 只有已附加且為 CheckAlways 或 OnPush 且為 dirty 的 component 才應刷新</span></span><br><span class="line">      <span class="title function_">refreshContainsDirtyView</span>(componentView);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一個條件定義是否會檢查 component：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">viewAttachedToChangeDetector</span>(componentView)) &#123; ... &#125;</span><br><span class="line"><span class="keyword">if</span> (componentView[<span class="variable constant_">FLAGS</span>] &amp; (<span class="title class_">LViewFlags</span>.<span class="property">CheckAlways</span> | <span class="title class_">LViewFlags</span>.<span class="property">Dirty</span>)) &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>主要條件是 component 的 <code>changeDetectorRef</code> 必須附加到 component 樹。<br>如果它未附加，則既不會檢查 component 本身，也不會檢查其子項或包含的 transplanted views。</p>
<p>如果主要條件成立，則如果 component 不是 <code>OnPush</code>，或者如果它是 <code>OnPush</code> 且為 dirty，則將檢查該 component。<br>在 <code>refreshView</code> 函式的末尾有一個邏輯可以重置 <a target="_blank" rel="noopener" href="https://wp.angular.love/deep-dive-into-the-onpush-change-detection-strategy-in-angular/">OnPush</a> component 上的 dirty 標誌：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在檢查 component 後重置 dirty 狀態</span></span><br><span class="line"><span class="keyword">if</span> (!isInCheckNoChangesPass) &#123;</span><br><span class="line">  lView[<span class="variable constant_">FLAGS</span>] &amp;= ~(<span class="title class_">LViewFlags</span>.<span class="property">Dirty</span> | <span class="title class_">LViewFlags</span>.<span class="property">FirstLViewPass</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最後，如果 component 包含 transplanted views，它們也會被檢查：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (componentView[<span class="variable constant_">TRANSPLANTED_VIEWS_TO_REFRESH</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// 只有已附加且為 CheckAlways 或 OnPush 且為 dirty 的 component 才應刷新</span></span><br><span class="line">  <span class="title function_">refreshContainsDirtyView</span>(componentView);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Template-函式"><a href="#Template-函式" class="headerlink" title="Template 函式"></a>Template 函式</h3><p>Angular 在 change detection 期間首先運行的 <code>executeTemplate</code> 函式的工作是執行來自 component 定義的 template 函式。<br>這個 template 函式是由編譯器為每個 component 生成的。<br>對於 <code>A</code> component：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;a-cmp&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`&lt;b-cmp [b]=&quot;1&quot;&gt;&lt;/b-cmp&gt; &#123;&#123; updateTemplate() &#125;&#125;`</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="title function_">ngDoCheck</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A: ngDoCheck&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">ngAfterContentChecked</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A: ngAfterContentChecked&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">ngAfterViewChecked</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A: ngAfterViewChecked&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">updateTemplate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A: updateTemplate&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定義如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  ɵɵdefineComponent <span class="keyword">as</span> defineComponent,</span><br><span class="line">  ɵɵelement <span class="keyword">as</span> element,</span><br><span class="line">  ɵɵtext <span class="keyword">as</span> text,</span><br><span class="line">  ɵɵproperty <span class="keyword">as</span> property,</span><br><span class="line">  ɵɵadvance <span class="keyword">as</span> advance,</span><br><span class="line">  ɵɵtextInterpolate <span class="keyword">as</span> textInterpolate</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">A.ɵfac = <span class="keyword">function</span> <span class="title function_">A_Factory</span>(<span class="params">t</span>) &#123; <span class="keyword">return</span> <span class="title function_">new</span> (t || A)(); &#125;;</span><br><span class="line">A.ɵcmp = <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: A,</span><br><span class="line">    <span class="attr">selectors</span>: [[<span class="string">&quot;a-cmp&quot;</span>]],</span><br><span class="line">    <span class="attr">template</span>: <span class="keyword">function</span> <span class="title function_">A_Template</span>(<span class="params">rf, ctx</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (rf &amp; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="title function_">element</span>(<span class="number">0</span>, <span class="string">&quot;b-cmp&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="title function_">text</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (rf &amp; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="title function_">property</span>(<span class="string">&quot;b&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="title function_">advance</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="title function_">textInterpolate</span>(<span class="string">&quot; &quot;</span>, ctx.<span class="title function_">updateTemplate</span>(), <span class="string">&quot;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>所有導入的函式都以 <code>ɵɵ</code> 前綴匯出，將它們標識為私有。</p>
<p>此 template 可以包含各種指令。在我們的例子中，它包含在初始化階段執行的創建指令 <code>element</code> 和 <code>text</code>，以及在 change detection 階段執行的 <code>property</code>、<code>advance</code> 和 <code>textInterpolate</code>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">A_Template</span>(<span class="params">rf, ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (rf &amp; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="title function_">element</span>(<span class="number">0</span>, <span class="string">&#x27;b-cmp&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_">text</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (rf &amp; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="title function_">property</span>(<span class="string">&#x27;b&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="title function_">advance</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="title function_">textInterpolate</span>(<span class="string">&#x27; &#x27;</span>, ctx.<span class="title function_">updateTemplate</span>(), <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這些是在 change detection 期間按順序執行的指令。</p>
<h3 id="生命周期-hook"><a href="#生命周期-hook" class="headerlink" title="生命周期 hook"></a>生命周期 hook</h3><p>Angular component 可以使用生命週期 hook 方法來利用 component 或 directive 生命週期中的關鍵事件。<br>當 Angular 創建 component 類別並渲染 component 視圖及其子視圖時，生命週期就會開始。<br>當 Angular 檢查資料綁定的屬性何時發生變化時，生命週期會繼續進行 change detection，並根據需要更新視圖和 component 實例。<br>當 Angular 銷毀 component 實例並從 DOM 中移除其渲染的 template 時，生命週期會結束。</p>
<p><strong>重要的是要理解，生命週期 hook 方法是在 change detection 期間執行的。</strong></p>
<p>以下是可用的生命週期方法的完整列表：</p>
<ul>
<li>onChanges</li>
<li>onInit</li>
<li>doCheck</li>
<li>afterContentInit</li>
<li>afterContentChecked</li>
<li>afterViewInit</li>
<li>afterViewChecked</li>
<li>ngOnDestroy</li>
</ul>
<p>其中 <code>onInit</code>、<code>afterContentInit</code> 和 <code>afterViewInit</code> 僅在初始 change detection 運行（第一次運行）期間執行。<br><code>ngOnDestroy</code> hook 僅在銷毀 component 之前執行一次。<br>其餘 4 個方法在每個 change detection 週期執行：</p>
<ul>
<li>onChanges</li>
<li>doCheck</li>
<li>afterContentChecked</li>
<li>afterViewChecked</li>
</ul>
<p>您也可以將 component 的 <code>constructor</code> 視為一種生命週期事件，它在創建 component 實例時執行。<br>然而，從 component 初始化階段的角度來看，建構子和生命週期方法之間存在巨大差異。</p>
<p>Angular 啟動過程由兩個主要階段組成：</p>
<ul>
<li>建構 component 樹</li>
<li>運行 change detection</li>
</ul>
<p>並且在 Angular 建構 component 樹時會呼叫 component 的建構子。包括 <code>ngOnInit</code> 在內的所有生命週期 hooks 都會作為後續 change detection 階段的一部分被呼叫。</p>
<p>同樣重要的是要理解，<strong>當 Angular 為當前 component 運行 change detection 時，大多數生命週期 hooks 會在子 component 上呼叫。</strong><br>只有 <code>ngAfterViewChecked</code> hook 的行為略有不同。</p>
<p>我們可以將此 component 的結構用於定義一個由 3 個 component 組成的層次結構 <code>[A -&gt; B -&gt; C]</code>，以記錄方法呼叫的順序：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;a-cmp&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`&lt;b-cmp [b]=&quot;1&quot;&gt;&lt;/b-cmp&gt; &#123;&#123; updateTemplate() &#125;&#125;`</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">  <span class="title function_">ngDoCheck</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A: ngDoCheck&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">ngAfterContentChecked</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A: ngAfterContentChecked&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">ngAfterViewChecked</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A: ngAfterViewChecked&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">updateTemplate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;A: updateTemplate&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;b-cmp&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`&lt;c-cmp [b]=&quot;1&quot;&gt;&lt;/c-cmp&gt; &#123;&#123;updateTemplate()&#125;&#125;`</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">B</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;c-cmp&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`&#123;&#123; updateTemplate() &#125;&#125;`</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">C</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>這是 hooks 呼叫和綁定更新的順序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Entering view: A</span><br><span class="line">    B: updateBinding</span><br><span class="line">    B: ngOnChanges</span><br><span class="line">    B: ngDoCheck</span><br><span class="line">        A: updateTemplate</span><br><span class="line">    B: ngAfterContentChecked</span><br><span class="line">    Entering view: B</span><br><span class="line">        С: updateBinding</span><br><span class="line">        C: ngOnChanges</span><br><span class="line">        С: ngDoCheck</span><br><span class="line">            B: updateTemplate</span><br><span class="line">        С: ngAfterContentChecked</span><br><span class="line">        Entering view: C</span><br><span class="line">            С: updateTemplate</span><br><span class="line">            С: ngAfterViewChecked</span><br><span class="line">    B: ngAfterViewChecked</span><br><span class="line">A: ngAfterViewChecked</span><br></pre></td></tr></table></figure>

<p>在此處<a target="_blank" rel="noopener" href="https://stackblitz.com/edit/angular-ivy-jkvjgz?file=src/app/components.ts,src/app/app.module.ts,src/app/app.component.ts">檢查</a>。</p>
<p>如您所見，當 Angular 正在為 <code>A</code> component 運行檢查時，生命週期方法 <code>ngOnChanges</code> 和 <code>ngDoCheck</code> 在 <code>B</code> component 上執行。這有點出乎意料，但完全合乎邏輯。當 Angular 為 <code>A</code> component 運行 change detection 時，它會在 template 內部運行指令，這會更新子 component <code>B</code> 上的 bindings。因此，一旦更新了 B component 上的屬性，透過在 component 上運行 <code>ngOnChanges</code> 來通知 <code>B</code> component 關於這一點是有意義的。</p>
<h3 id="View-和-Content-Queries"><a href="#View-和-Content-Queries" class="headerlink" title="View 和 Content Queries"></a>View 和 Content Queries</h3><p>View 和 Content query 是我們在運行時取得 component template 中元素的方法。<br>通常，評估 query 的結果可在 <code>ngAfterViewChecked</code> 或 <code>ngAfterContentChecked</code> 生命周期方法中取得。<br>如果我們查看運算順序，我們可以看出原因：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Content query 結果必須在呼叫 content hooks 之前刷新。</span></span><br><span class="line"><span class="keyword">if</span> (tView.<span class="property">contentQueries</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="title function_">refreshContentQueries</span>(tView, lView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 執行 content hooks (AfterContentInit, AfterContentChecked)</span></span><br><span class="line"><span class="keyword">const</span> contentCheckHooks = tView.<span class="property">contentCheckHooks</span>;</span><br><span class="line"><span class="keyword">if</span> (contentCheckHooks !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="title function_">executeCheckHooks</span>(lView, contentCheckHooks);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// View query 結果必須在呼叫 content hooks 之前刷新。</span></span><br><span class="line"><span class="keyword">const</span> viewQuery = tView.<span class="property">viewQuery</span>;</span><br><span class="line"><span class="keyword">if</span> (viewQuery !== <span class="literal">null</span>) &#123;</span><br><span class="line">  executeViewQueryFn&lt;T&gt;(<span class="title class_">RenderFlags</span>.<span class="property">Update</span>, viewQuery, context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 執行 view hooks (AfterViewInit, AfterViewChecked)</span></span><br><span class="line"><span class="keyword">const</span> viewCheckHooks = tView.<span class="property">viewCheckHooks</span>;</span><br><span class="line"><span class="keyword">if</span> (viewCheckHooks !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="title function_">executeCheckHooks</span>(lView, viewCheckHooks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這些是指上面列表中 Content Queries 的運算 <code>#5</code> 和 <code>#6</code>，以及 View Queries 的運算 <code>#9</code> 和 <code>#10</code>。</p>
<p>Angular 透過執行透過 component 定義定義的函式來更新 query 結果。<br>對於如下的 component 定義</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;c-cmp&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">``</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">C</span> &#123;</span><br><span class="line">  <span class="meta">@ViewChild</span>(<span class="string">&#x27;ctrl&#x27;</span>) <span class="attr">viewChild</span>: <span class="built_in">any</span>;</span><br><span class="line">  <span class="meta">@ContentChild</span>(<span class="string">&#x27;ctrl&#x27;</span>) <span class="attr">contentChild</span>: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  title = <span class="string">&#x27;c-comp is here&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新 query 的函式如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">C.ɵcmp = <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: C,</span><br><span class="line">  <span class="attr">selectors</span>: [[<span class="string">&quot;c-cmp&quot;</span>]],</span><br><span class="line">  <span class="attr">contentQueries</span>: <span class="keyword">function</span> <span class="title function_">C_ContentQueries</span>(<span class="params">rf, ctx, dirIndex</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (rf &amp; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="title function_">contentQuery</span>(dirIndex, _c0, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rf &amp; <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> _t;</span><br><span class="line">      <span class="title function_">queryRefresh</span>(_t = [<span class="string">&quot;loadQuery&quot;</span>]()) &amp;&amp; (ctx.<span class="property">contentChild</span> = _t.<span class="property">first</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">viewQuery</span>: <span class="keyword">function</span> <span class="title function_">C_Query</span>(<span class="params">rf, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (rf &amp; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="title function_">viewQuery</span>(_c0, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rf &amp; <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> _t;</span><br><span class="line">      <span class="title function_">queryRefresh</span>(_t = [<span class="string">&quot;loadQuery&quot;</span>]()) &amp;&amp; (ctx.<span class="property">viewChild</span> = _t.<span class="property">first</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">template</span>: <span class="keyword">function</span> <span class="title function_">C_Template</span>(<span class="params">rf, ctx</span>) &#123;&#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Embedded-Views"><a href="#Embedded-Views" class="headerlink" title="Embedded Views"></a>Embedded Views</h3><p>Angular 提供了一種機制，透過使用視圖容器在 component 的 template 中實現動態行為。<br>您可以使用 component template 內的 <code>ng-container</code> 標籤建立視圖容器，並使用 <code>@ViewChild</code> query 存取它。<br>這些容器提供了一種實例化 template 程式碼的方法，允許它被重複使用並根據需要輕鬆修改。</p>
<p>視圖容器提供 API 來建立、操作和移除動態視圖。<br>我將它們稱為動態視圖，而不是框架為 template 中找到的靜態 component 建立的靜態視圖。<br>Angular 不使用視圖容器來處理靜態視圖，而是在特定於子 component 的節點內保留對子視圖的引用。<br>我們將在「渲染引擎內部」章節中更多地討論視圖類型的差異。</p>
<p>嵌入式視圖是透過使用 <code>viewContainerRef.createEmbeddedView()</code> 方法實例化 <code>TemplateRef</code> 從 template 建立的。<br>視圖容器也可以包含透過使用 <code>createComponent()</code> 方法實例化 component 建立的 host 視圖。<br>視圖容器實例可以包含其他視圖容器，從而建立視圖層次結構。<br>所有結構指令（如 <code>ngIf</code> 和 <code>ngFor</code>）都使用視圖容器從指令的 template 建立動態視圖。</p>
<p>這些嵌入式視圖在列表中的步驟 <code>#4</code> 期間檢查：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 刷新透過 ViewContainerRef.createEmbeddedView() 加入的視圖</span></span><br><span class="line"><span class="title function_">refreshEmbeddedViews</span>(lView);</span><br></pre></td></tr></table></figure>

<p>對於如下的 template：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>My component<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ng-container</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">ngTemplateOutlet</span>]=<span class="string">&quot;template&quot;</span></span></span><br><span class="line"><span class="tag">  [<span class="attr">ngTemplateOutletContext</span>]=<span class="string">&quot;&#123;$implicit: greeting&#125;&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a-comp</span>&gt;</span><span class="tag">&lt;/<span class="name">a-comp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ng-template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>I am an embedded view<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ng-template</span>&gt;</span>&lt;/ng-template</span><br><span class="line">&gt;<span class="tag">&lt;/<span class="name">ng-template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>LView</code> 內部的視圖節點可以表示為這樣：</p>
<p><img src="https://wp.angular.love/wp-content/uploads/2024/08/1-6.png" alt="Image 14: Image alt"></p>
<p><strong>有一種稱為 transplanted view 的嵌入式視圖的特殊情況。</strong></p>
<p>transplanted view 是一個嵌入式視圖，其 template 在託管嵌入式視圖的 component 的 template 之外宣告。<br>使用 <code>&lt;ng-template&gt;</code> 宣告 template 的 component 與使用視圖容器插入使用此 template 建立的嵌入式視圖的 component 不同。</p>
<p>在以下範例中，template 在 <code>AppComp</code> 內宣告，但在 <code>LibComp</code> component 內渲染，因此使用此 template 建立的嵌入式視圖被視為 transplanted：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;lib-comp&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    LibComp: &#123;&#123; greeting &#125;&#125;!</span></span><br><span class="line"><span class="string">    &lt;ng-container</span></span><br><span class="line"><span class="string">      [ngTemplateOutlet]=&quot;template&quot;</span></span><br><span class="line"><span class="string">      [ngTemplateOutletContext]=&quot;&#123; $implicit: greeting &#125;&quot;</span></span><br><span class="line"><span class="string">    &gt;</span></span><br><span class="line"><span class="string">    &lt;/ng-container&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibComp</span> &#123;</span><br><span class="line">  <span class="meta">@Input</span>()</span><br><span class="line">  <span class="attr">template</span>: <span class="title class_">TemplateRef</span>;</span><br><span class="line">  <span class="attr">greeting</span>: <span class="built_in">string</span> = <span class="string">&#x27;Hello&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    AppComp: &#123;&#123; name &#125;&#125;!</span></span><br><span class="line"><span class="string">    &lt;ng-template #myTmpl let-greeting&gt; &#123;&#123; greeting &#125;&#125; &#123;&#123; name &#125;&#125;! &lt;/ng-template&gt;</span></span><br><span class="line"><span class="string">    &lt;lib-comp [template]=&quot;myTmpl&quot;&gt;&lt;/lib-comp&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppComp</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>運算 #3 <code>markTransplantedViewsForRefresh</code> 處理此類視圖的更新。</p>

      
    </div>
      
      <footer>
        
        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>


<section id="comment">
  
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:viaje9.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/TranslationKonjac/2025/04/05/zh-tw-How-to-Get-Rich/">如何致富（不靠運氣）</a>
      </li>
    
      <li>
        <a href="/TranslationKonjac/2025/02/17/zh-tw-change-detection-and-component-trees-in-angular-applications/">Angular 應用程式中的變更偵測與元件樹</a>
      </li>
    
      <li>
        <a href="/TranslationKonjac/2025/01/20/zh-tw-local-change-detection-and-angular-signals-in-templates-in-details/">局部變更偵測與 Angular Signals 在模板中的詳細應用</a>
      </li>
    
      <li>
        <a href="/TranslationKonjac/2025/01/19/zh-tw-running-change-detection-components-tree/">執行變更偵測 – 元件樹</a>
      </li>
    
      <li>
        <a href="/TranslationKonjac/2025/01/13/zh-tw-change-detection-big-picture-unidirectional-data-flow/">變更偵測大觀 – 單向數據流</a>
      </li>
    
  </ul>
</div>


  

  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2025 Brian
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



</body>
</html>

